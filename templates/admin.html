<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - SciG Mode MCP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {% include "_neo_theme_head.html" %}
  <style>
    .admin-nav-link{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.85rem;
      border-radius: 14px;
      border: 2px solid #111;
      background: #fff7dc;
      color: #111;
      font-size: 0.82rem;
      font-weight: 700;
      box-shadow: 3px 3px 0 #111;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .admin-nav-link:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0 #111;
      background: #bce7ff;
    }
    .admin-nav-link.active {
      background: #8ce99a;
      color: #111;
    }

    .tg-shell{
      background:
        radial-gradient(circle at 9px 9px, rgba(0,0,0,.1) 1px, transparent 1.2px) 0 0 / 20px 20px,
        #fffef8;
      border: 2px solid #111;
      border-radius: 18px;
    }
    .tg-row { display: flex; gap: 10px; margin: 12px 0; align-items: flex-end; }
    .tg-row.user { justify-content: flex-end; }
    .tg-row.assistant { justify-content: flex-start; }
    .tg-avatar{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fffef8;
      color: #111;
      font-weight: 700;
      font-size: 12px;
      border: 2px solid #111;
      box-shadow: 3px 3px 0 #111;
    }
    .tg-bubble{
      max-width: 74%;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: 3px 3px 0 #111;
      border: 2px solid #111;
    }
    .tg-row.user .tg-bubble{
      background: #b8e1ff;
      border-radius: 16px 16px 6px 16px;
    }
    .tg-row.assistant .tg-bubble{
      background: #ffd7ad;
      border-radius: 16px 16px 16px 6px;
    }
    .tg-name { font-weight: 700; font-size: 11px; color: #111; margin-bottom: 4px; }
    .tg-meta { margin-top: 6px; font-size: 10px; color: #222; text-align: right; }

    .admin-hero {
      border: 3px solid #111;
      box-shadow: 6px 6px 0 #111;
      border-radius: 22px;
      padding: 0.9rem 1rem;
      background: #fffef7;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-[1500px] w-full mx-auto p-4 md:p-8 space-y-4">

    <div class="admin-hero flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold">Admin Panel</h1>
        <p class="text-sm text-white/70">Kelola code MCP. Token disembunyikan demi keamanan.</p>
      </div>

      <div class="flex items-center gap-2">
        <div class="text-sm text-white/80">
          Login sebagai <span class="font-semibold">{{ username }}</span>
        </div>
        <a href="/logout"
           class="px-3 py-2 rounded-xl bg-white/10 border border-white/15 hover:bg-white/15 transition text-sm">
          Logout
        </a>
      </div>
    </div>

    <div class="bg-white/10 border border-white/15 rounded-2xl p-3 backdrop-blur">
      <div class="flex flex-wrap gap-2">
        <a href="/admin/codes" class="admin-nav-link{% if active_page == 'codes' %} active{% endif %}">Code MCP</a>
        <a href="/admin/users" class="admin-nav-link{% if active_page == 'users' %} active{% endif %}">Tambah/User</a>
        <a href="/admin/audit" class="admin-nav-link{% if active_page == 'audit' %} active{% endif %}">Audit Logs</a>
        <a href="/admin/monitoring" class="admin-nav-link{% if active_page == 'monitoring' %} active{% endif %}">Monitoring</a>
        <a href="/admin/chat-viewer" class="admin-nav-link{% if active_page == 'chat_viewer' %} active{% endif %}">Chat Viewer</a>
      </div>
    </div>

    <div id="section-codes" class="grid grid-cols-1 lg:grid-cols-3 gap-4{% if active_page != 'codes' %} hidden{% endif %}">
      <!-- Create code -->
      <div class="lg:col-span-1 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur">
        <h2 class="font-semibold mb-2">Buat Code Baru</h2>
        <p class="text-xs text-white/70 mb-3">
          Isi dengan URL MCP endpoint (contoh: <span class="font-mono">wss://api.xiaozhi.me/mcp/?token=...</span>)
        </p>

        <form method="POST" action="/admin/codes" class="space-y-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div>
            <label class="block text-xs text-white/70 mb-1">Token / WS URL</label>
            <textarea name="token" required rows="4"
              class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400"
              placeholder="wss://api.xiaozhi.me/mcp/?token=..."></textarea>
          </div>
          <button class="w-full py-2.5 rounded-xl font-semibold bg-cyan-600 hover:bg-cyan-500 transition">
            Buat Code
          </button>
        </form>
      </div>

      <!-- List codes -->
      <div class="lg:col-span-2 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur">
        <div class="flex items-center justify-between gap-3">
          <h2 class="font-semibold">Daftar Codes</h2>
          <div class="w-full max-w-xs">
            <input id="search" type="text"
              class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-sm"
              placeholder="Cari: code / username / status...">
          </div>
        </div>

        <div class="mt-4 overflow-x-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm" id="codesTable">
            <thead class="bg-black/25 text-white/80">
              <tr>
                <th class="text-left px-3 py-2">Code</th>
                <th class="text-left px-3 py-2">Owner</th>
                <th class="text-left px-3 py-2">Status</th>
                <th class="text-left px-3 py-2">Aksi</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-white/10">
              {% for c in codes %}
              <tr class="codeRow">
                <td class="px-3 py-2 align-top">
                  <div class="font-mono font-semibold">{{ c.code }}</div>
                  <div class="text-xs text-white/60">id={{ c.id }} - {{ c.created_at }}</div>
                </td>

                <td class="px-3 py-2 align-top">
                  {% if c.used_by_username %}
                    <div class="font-semibold">{{ c.used_by_username }}</div>
                    <div class="text-xs text-white/60">used_by={{ c.used_by }}</div>
                  {% else %}
                    <div class="text-white/70">Belum di-claim</div>
                  {% endif %}
                </td>

                <td class="px-3 py-2 align-top">
                  {% if c.used_by %}
                    <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-blue-500/15 border border-blue-400/30 text-blue-200 text-xs mb-2">
                      <span class="w-2 h-2 rounded-full bg-blue-400"></span> Claimed
                    </div>
                  {% else %}
                    <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-slate-500/15 border border-slate-400/30 text-slate-200 text-xs mb-2">
                      <span class="w-2 h-2 rounded-full bg-slate-400"></span> Unclaimed
                    </div>
                  {% endif %}
                  {% if not c.has_token %}
                    <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-red-500/15 border border-red-400/30 text-red-200 text-xs mb-2">
                      <span class="w-2 h-2 rounded-full bg-red-400"></span> Token kosong
                    </div>
                  {% endif %}

                  {% set connected = (c.is_connected or 0) %}
                  {% if connected %}
                    <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-emerald-500/15 border border-emerald-400/30 text-emerald-200 text-xs">
                      <span class="w-2 h-2 rounded-full bg-emerald-400"></span> Connected
                    </div>
                    <div class="text-xs text-white/60 mt-1">last_ok: {{ c.last_ok_at or "-" }}</div>
                  {% else %}
                    <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-amber-500/15 border border-amber-400/30 text-amber-200 text-xs">
                      <span class="w-2 h-2 rounded-full bg-amber-400"></span> Not connected
                    </div>
                    <div class="text-xs text-white/60 mt-1">last_err: {{ c.last_err_at or "-" }}</div>
                    {% if c.last_error %}
                      <div class="mt-1 text-xs text-red-200/90 bg-red-500/10 border border-red-400/20 rounded-lg p-2">
                        {{ c.last_error }}
                      </div>
                    {% endif %}
                  {% endif %}
                </td>

                <td class="px-3 py-2 align-top">
                  <div class="flex flex-col gap-2">
                    <form method="POST" action="/admin/codes/unclaim" class="unclaimForm">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                      <input type="hidden" name="code_id" value="{{ c.id }}">
                      <button type="submit"
                        class="w-full px-3 py-2 rounded-xl bg-amber-600/80 hover:bg-amber-500 transition text-xs font-semibold">
                        Unclaim + Delete User
                      </button>
                    </form>
                    <details class="rounded-lg border border-white/10 p-2 bg-white/5">
                      <summary class="cursor-pointer text-xs text-cyan-200">Edit token</summary>
                      <form method="POST" action="/admin/codes/update" class="mt-2 space-y-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="code_id" value="{{ c.id }}">
                        <textarea name="token" rows="3" required
                          class="w-full bg-black/25 border border-white/15 rounded-lg px-2 py-1 text-xs"
                          placeholder="Paste token baru (token lama tidak ditampilkan)"></textarea>
                        <button type="submit"
                          class="w-full px-3 py-2 rounded-xl bg-cyan-600/80 hover:bg-cyan-500 transition text-xs font-semibold">
                          Update Token
                        </button>
                      </form>
                    </details>
                    <details class="rounded-lg border border-white/10 p-2 bg-white/5">
                      <summary class="cursor-pointer text-xs text-cyan-200">Edit code (10 karakter)</summary>
                      <form method="POST" action="/admin/codes/update-code" class="mt-2 space-y-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="code_id" value="{{ c.id }}">
                        <input name="code" maxlength="10" required
                          class="w-full bg-black/25 border border-white/15 rounded-lg px-2 py-1 text-xs font-mono"
                          value="{{ c.code }}" placeholder="contoh: Ab12Cd34Ef">
                        <button type="submit"
                          class="w-full px-3 py-2 rounded-xl bg-cyan-600/80 hover:bg-cyan-500 transition text-xs font-semibold">
                          Update Code
                        </button>
                      </form>
                    </details>
                    <form method="POST" action="/admin/codes/delete" class="deleteCodeForm">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                      <input type="hidden" name="code_id" value="{{ c.id }}">
                      <button type="submit"
                        class="w-full px-3 py-2 rounded-xl bg-red-600/80 hover:bg-red-500 transition text-xs font-semibold">
                        Delete Code
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <p class="text-xs text-white/60 mt-3">
          Unclaim akan melepas <span class="font-mono">used_by</span>, reset status koneksi, dan menghapus user pemilik code.
        </p>
      </div>
    </div>

    <details id="section-users" class="mt-4 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur{% if active_page != 'users' %} hidden{% endif %}"{% if active_page == 'users' %} open{% endif %}>
      <summary class="cursor-pointer flex items-center justify-between gap-3">
        <h2 class="font-semibold">Tambah User</h2>
        <div class="text-xs text-white/60">Klik untuk buka/tutup.</div>
      </summary>
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Create user -->
      <div class="lg:col-span-1 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur">
        <h2 class="font-semibold mb-2">Form User Baru</h2>
        <p class="text-xs text-white/70 mb-3">Buat akun user/admin secara manual.</p>

        <form method="POST" action="/admin/users" class="space-y-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div>
            <label class="block text-xs text-white/70 mb-1">Username</label>
            <input name="username" required
              class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400 text-sm"
              placeholder="username">
          </div>
          <div>
            <label class="block text-xs text-white/70 mb-1">Password</label>
            <input type="password" name="password" required
              class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400 text-sm"
              placeholder="min 6 karakter">
          </div>
          <div>
            <label class="block text-xs text-white/70 mb-1">Role</label>
            <select name="role"
              class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400 text-sm">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <button class="w-full py-2.5 rounded-xl font-semibold bg-cyan-600 hover:bg-cyan-500 transition">
            Create User
          </button>
        </form>
      </div>

      <!-- List users -->
      <div class="lg:col-span-2 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur">
        <div class="flex items-center justify-between gap-3">
          <h2 class="font-semibold">Users</h2>
          <div class="w-full max-w-xs">
            <input id="userSearch" type="text"
              class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-sm"
              placeholder="Cari: username / role / status...">
          </div>
        </div>

        <div class="mt-4 overflow-x-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm" id="usersTable">
            <thead class="bg-black/25 text-white/80">
              <tr>
                <th class="text-left px-3 py-2">ID</th>
                <th class="text-left px-3 py-2">Username</th>
                <th class="text-left px-3 py-2">Role</th>
                <th class="text-left px-3 py-2">Codes</th>
                <th class="text-left px-3 py-2">Status</th>
                <th class="text-left px-3 py-2">Aksi</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/10">
              {% if users %}
                {% for u in users %}
                <tr class="userRow">
                  <td class="px-3 py-2 align-top">
                    <div class="font-mono text-xs">{{ u.id }}</div>
                  </td>
                  <td class="px-3 py-2 align-top">
                    <div class="font-semibold">{{ u.username }}</div>
                    <div class="text-xs text-white/60">created: {{ u.created_at }}</div>
                  </td>
                  <td class="px-3 py-2 align-top">
                    <div class="text-xs">{{ u.role }}</div>
                  </td>
                  <td class="px-3 py-2 align-top">
                    <div class="text-xs">total: {{ u.code_count or 0 }}</div>
                    <div class="text-xs text-white/60">connected: {{ u.connected_codes or 0 }}</div>
                  </td>
                  <td class="px-3 py-2 align-top">
                    {% set online = (u.connected_codes or 0) > 0 %}
                    {% if online %}
                      <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-emerald-500/15 border border-emerald-400/30 text-emerald-200 text-xs">
                        <span class="w-2 h-2 rounded-full bg-emerald-400"></span> Online
                      </div>
                      <div class="text-xs text-white/60 mt-1">last_ok: {{ u.last_ok_at or "-" }}</div>
                    {% else %}
                      <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-slate-500/15 border border-slate-400/30 text-slate-200 text-xs">
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span> Offline
                      </div>
                      <div class="text-xs text-white/60 mt-1">last_err: {{ u.last_err_at or "-" }}</div>
                    {% endif %}
                  </td>
                  <td class="px-3 py-2 align-top">
                    <div class="flex flex-col gap-2">
                      <details class="rounded-lg border border-white/10 p-2 bg-white/5">
                        <summary class="cursor-pointer text-xs text-cyan-200">Edit user</summary>
                        <form method="POST" action="/admin/users/update" class="mt-2 space-y-2">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                          <input type="hidden" name="user_id" value="{{ u.id }}">
                          <select name="role"
                            class="w-full bg-black/25 border border-white/15 rounded-lg px-2 py-1 text-xs">
                            <option value="user" {% if u.role == "user" %}selected{% endif %}>user</option>
                            <option value="admin" {% if u.role == "admin" %}selected{% endif %}>admin</option>
                          </select>
                          <input type="password" name="password"
                            class="w-full bg-black/25 border border-white/15 rounded-lg px-2 py-1 text-xs"
                            placeholder="Password baru (opsional)">
                          <button type="submit"
                            class="w-full px-3 py-2 rounded-xl bg-cyan-600/80 hover:bg-cyan-500 transition text-xs font-semibold">
                            Update User
                          </button>
                        </form>
                      </details>
                      <form method="POST" action="/admin/users/delete" class="deleteUserForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <button type="submit"
                          class="w-full px-3 py-2 rounded-xl bg-red-600/80 hover:bg-red-500 transition text-xs font-semibold">
                          Delete User
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="px-3 py-3 text-xs text-white/60">Belum ada user.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <p class="text-xs text-white/60 mt-3">
          Status Online berdasarkan koneksi MCP aktif pada salah satu code milik user.
        </p>
      </div>
      </div>
    </details>

    <details id="section-audit" class="mt-4 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur{% if active_page != 'audit' %} hidden{% endif %}"{% if active_page == 'audit' %} open{% endif %}>
      <summary class="cursor-pointer flex items-center justify-between gap-3">
        <h2 class="font-semibold">Audit Logs (Admin)</h2>
        <div class="text-xs text-white/60">Filter + pagination. Klik untuk buka/tutup.</div>
      </summary>

      <form method="GET" action="/admin/audit" class="mt-4 grid grid-cols-1 md:grid-cols-6 gap-2">
        <input
          name="audit_admin"
          value="{{ audit.filters.admin_username }}"
          class="bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-xs"
          placeholder="Admin username">
        <input
          name="audit_action"
          value="{{ audit.filters.action }}"
          class="bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-xs"
          placeholder="Action">
        <input
          type="date"
          name="audit_from"
          value="{{ audit.filters.date_from }}"
          class="bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-xs">
        <input
          type="date"
          name="audit_to"
          value="{{ audit.filters.date_to }}"
          class="bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-xs">
        <select
          name="audit_page_size"
          class="bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-xs">
          <option value="25" {% if audit.page_size == 25 %}selected{% endif %}>25 / halaman</option>
          <option value="50" {% if audit.page_size == 50 %}selected{% endif %}>50 / halaman</option>
          <option value="100" {% if audit.page_size == 100 %}selected{% endif %}>100 / halaman</option>
        </select>
        <div class="flex gap-2">
          <button class="w-full px-3 py-2 rounded-xl bg-cyan-600/80 hover:bg-cyan-500 transition text-xs font-semibold">
            Terapkan
          </button>
          <a href="/admin/audit"
             class="w-full px-3 py-2 text-center rounded-xl bg-slate-700/80 hover:bg-slate-600 transition text-xs font-semibold">
            Reset
          </a>
        </div>
      </form>

      <div class="mt-4 overflow-x-auto rounded-xl border border-white/10">
        <table class="min-w-full text-sm" id="auditTable">
          <thead class="bg-black/25 text-white/80">
            <tr>
              <th class="text-left px-3 py-2">Waktu</th>
              <th class="text-left px-3 py-2">Admin</th>
              <th class="text-left px-3 py-2">Action</th>
              <th class="text-left px-3 py-2">Target</th>
              <th class="text-left px-3 py-2">IP</th>
              <th class="text-left px-3 py-2">Details</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/10">
            {% if audit.logs %}
              {% for l in audit.logs %}
              <tr>
                <td class="px-3 py-2 align-top text-xs">{{ l.created_at }}</td>
                <td class="px-3 py-2 align-top text-xs">
                  <div class="font-semibold">{{ l.admin_username or "-" }}</div>
                  <div class="text-white/60">id={{ l.admin_user_id or "-" }}</div>
                </td>
                <td class="px-3 py-2 align-top text-xs font-mono">{{ l.action }}</td>
                <td class="px-3 py-2 align-top text-xs">
                  <div>{{ l.target_type or "-" }}</div>
                  <div class="text-white/60">{{ l.target_id or "-" }}</div>
                </td>
                <td class="px-3 py-2 align-top text-xs">
                  <div>{{ l.ip or "-" }}</div>
                </td>
                <td class="px-3 py-2 align-top text-xs">
                  <div class="max-w-xl break-all text-white/70">{{ l.details or "-" }}</div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="px-3 py-3 text-xs text-white/60">Belum ada audit log.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-white/70">
        <div>
          Page {{ audit.page }} / {{ audit.total_pages }} | Total logs: {{ audit.total }}
        </div>
        <div class="flex items-center gap-2">
          {% if audit.page > 1 %}
            <a href="/admin/audit?audit_page={{ audit.page - 1 }}&audit_page_size={{ audit.page_size }}&audit_admin={{ audit.filters.admin_username }}&audit_action={{ audit.filters.action }}&audit_from={{ audit.filters.date_from }}&audit_to={{ audit.filters.date_to }}"
               class="px-3 py-1.5 rounded-lg bg-slate-700/80 hover:bg-slate-600 transition">
              Prev
            </a>
          {% endif %}
          {% if audit.page < audit.total_pages %}
            <a href="/admin/audit?audit_page={{ audit.page + 1 }}&audit_page_size={{ audit.page_size }}&audit_admin={{ audit.filters.admin_username }}&audit_action={{ audit.filters.action }}&audit_from={{ audit.filters.date_from }}&audit_to={{ audit.filters.date_to }}"
               class="px-3 py-1.5 rounded-lg bg-slate-700/80 hover:bg-slate-600 transition">
              Next
            </a>
          {% endif %}
        </div>
      </div>
    </details>

    <details id="section-monitoring" class="mt-4 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur{% if active_page != 'monitoring' %} hidden{% endif %}"{% if active_page == 'monitoring' %} open{% endif %}>
      <summary class="cursor-pointer flex items-center justify-between gap-3">
        <h2 class="font-semibold">Monitoring</h2>
        <div class="text-xs text-white/60">Refresh otomatis tiap 5 detik. Klik untuk buka/tutup.</div>
      </summary>

      <div id="mAlerts" class="mt-4 hidden p-3 rounded-xl border text-sm"></div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div id="cardUptime" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">Uptime</div>
            <button type="button" data-m-refresh="uptime" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mUptime">-</div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mUptimeAt">-</span></div>
        </div>

        <div id="cardHttp" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">HTTP (1m / 5m)</div>
            <button type="button" data-m-refresh="http" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mHttpRate">-</div>
          <div class="text-xs text-white/60 mt-1">Total: <span id="mHttpTotal">-</span> | Errors: <span id="mHttpErr">-</span></div>
          <div class="text-xs text-white/60 mt-1">Error 1m: <span id="mHttpErrRate">-</span></div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mHttpAt">-</span></div>
        </div>

        <div id="cardMessages" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">Messages (1m / 5m)</div>
            <button type="button" data-m-refresh="messages" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mMsgRate">-</div>
          <div class="text-xs text-white/60 mt-1">Total: <span id="mMsgTotal">-</span></div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mMsgAt">-</span></div>
        </div>

        <div id="cardWs" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">WS Clients</div>
            <button type="button" data-m-refresh="ws" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mWsClients">-</div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mWsAt">-</span></div>
        </div>

        <div id="cardWorkers" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">MCP Workers</div>
            <button type="button" data-m-refresh="workers" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mMcpWorkers">-</div>
          <div class="text-xs text-white/60 mt-1">Enabled: <span id="mMcpEnabled">-</span></div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mWorkersAt">-</span></div>
        </div>

        <div id="cardMem" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">Process Memory</div>
            <button type="button" data-m-refresh="memory" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mMem">-</div>
          <div class="text-xs text-white/60 mt-1">Threads: <span id="mThreads">-</span></div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mMemAt">-</span></div>
        </div>

        <div id="cardCodes" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">Codes Connected / Total</div>
            <button type="button" data-m-refresh="codes" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mCodes">-</div>
          <div class="text-xs text-white/60 mt-1">Error state: <span id="mCodeErrors">-</span></div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mCodesAt">-</span></div>
        </div>

        <div id="cardDb" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">DB Status</div>
            <button type="button" data-m-refresh="db" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mDbStatus">-</div>
          <div class="text-xs text-white/60 mt-1">Latency: <span id="mDbLatency">-</span></div>
          <div class="text-xs text-red-200 mt-1" id="mDbError">-</div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mDbAt">-</span></div>
        </div>

        <div id="cardMcpHealth" class="rounded-xl border border-white/10 p-3 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-xs text-white/60">MCP Health</div>
            <button type="button" data-m-refresh="mcp" class="px-2 py-1 text-[11px] rounded-md bg-white/10 hover:bg-white/20">Refresh</button>
          </div>
          <div class="text-lg font-semibold" id="mMcpHealth">-</div>
          <div class="text-xs text-white/60 mt-1" id="mMcpDetail">-</div>
          <div class="text-[11px] text-white/60 mt-1">Updated: <span id="mMcpAt">-</span></div>
        </div>
      </div>
    </details>

    <details id="section-chat-viewer" class="mt-4 bg-white/10 border border-white/15 rounded-2xl p-5 backdrop-blur{% if active_page != 'chat_viewer' %} hidden{% endif %}"{% if active_page == 'chat_viewer' %} open{% endif %}>
      <summary class="cursor-pointer flex items-center justify-between gap-3">
        <h2 class="font-semibold">Chat Viewer (Admin)</h2>
        <div class="text-xs text-white/60">Baca chat Xiaozhi per user. Klik untuk buka/tutup.</div>
      </summary>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-white/70">Pilih User</label>
          <select id="chatUserSelect"
            class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-sm">
            <option value="">-- pilih --</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.username }} (id={{ u.id }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="text-xs text-white/70">Device ID</label>
          <select id="chatDeviceSelect"
            class="w-full bg-black/25 border border-white/15 rounded-xl px-3 py-2 text-sm">
            <option value="">-- pilih user dulu --</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="chatReloadBtn"
            class="w-full px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-sm">
            Reload Threads
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-1">
          <div class="text-xs text-white/60 mb-2">Threads</div>
          <div id="chatThreads" class="space-y-2 max-h-[420px] overflow-auto pr-1"></div>
        </div>
        <div class="md:col-span-2">
          <div class="text-xs text-white/60 mb-2">
            Thread: <span id="chatActiveThread" class="font-mono text-xs">-</span>
          </div>
          <div id="chatMessages" class="max-h-[420px] overflow-auto tg-shell p-3 text-slate-800"></div>
        </div>
      </div>
    </details>
  </div>

  <div id="toastBox" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <script>
    const QUERY_OK = {{ (ok or "") | tojson }};
    const QUERY_ERR = {{ (err or "") | tojson }};
    const ACTIVE_PAGE = {{ (active_page or "codes") | tojson }};
    const OK_LABELS = {
      code_created: "Code berhasil dibuat",
      code_updated: "Token code berhasil diperbarui",
      code_value_updated: "Nilai code berhasil diperbarui",
      code_deleted: "Code berhasil dihapus",
      code_unclaimed: "Code berhasil di-unclaim",
      user_created: "User berhasil dibuat",
      user_updated: "User berhasil diperbarui",
      user_deleted: "User berhasil dihapus",
    };

    function showToast(message, ok=true) {
      const box = document.getElementById("toastBox");
      if (!box || !message) return;
      const el = document.createElement("div");
      el.className =
        "max-w-[460px] px-3 py-2 rounded-xl border text-sm shadow-lg backdrop-blur " +
        (ok
          ? "bg-emerald-500/20 border-emerald-400/30 text-emerald-100"
          : "bg-red-500/20 border-red-400/30 text-red-100");
      el.textContent = message;
      box.appendChild(el);
      setTimeout(() => {
        try { el.remove(); } catch (e) {}
      }, 4200);
    }

    if (QUERY_OK) showToast(`OK: ${OK_LABELS[QUERY_OK] || QUERY_OK}`, true);
    if (QUERY_ERR) showToast(`Error: ${QUERY_ERR}`, false);

    // Search filter (by code / username / status)
    const search = document.getElementById("search");
    const rows = Array.from(document.querySelectorAll(".codeRow"));

    search.addEventListener("input", () => {
      const q = (search.value || "").toLowerCase().trim();
      rows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = text.includes(q) ? "" : "none";
      });
    });

    // Search filter (users)
    const userSearch = document.getElementById("userSearch");
    const userRows = Array.from(document.querySelectorAll(".userRow"));
    userSearch?.addEventListener("input", () => {
      const q = (userSearch.value || "").toLowerCase().trim();
      userRows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = text.includes(q) ? "" : "none";
      });
    });

    // confirm actions
    document.querySelectorAll(".codeRow").forEach(row => {
      const unclaimForm = row.querySelector(".unclaimForm");
      unclaimForm?.addEventListener("submit", (e) => {
        if (!confirm("Unclaim code ini? User pemilik code juga akan dihapus.")) {
          e.preventDefault();
        }
      });

      // confirm delete code
      const deleteCodeForm = row.querySelector(".deleteCodeForm");
      deleteCodeForm?.addEventListener("submit", (e) => {
        if (!confirm("Delete code ini? Tindakan ini tidak bisa dibatalkan.")) {
          e.preventDefault();
        }
      });
    });

    // confirm delete user
    document.querySelectorAll(".userRow").forEach(row => {
      const deleteUserForm = row.querySelector(".deleteUserForm");
      deleteUserForm?.addEventListener("submit", (e) => {
        if (!confirm("Delete user ini? Semua code milik user akan dihapus.")) {
          e.preventDefault();
        }
      });
    });

    // --- Admin Chat Viewer ---
    const chatUserSelect = document.getElementById("chatUserSelect");
    const chatDeviceSelect = document.getElementById("chatDeviceSelect");
    const chatThreads = document.getElementById("chatThreads");
    const chatMessages = document.getElementById("chatMessages");
    const chatActiveThread = document.getElementById("chatActiveThread");
    const chatReloadBtn = document.getElementById("chatReloadBtn");
    let ACTIVE_THREAD_ID = null;

    async function adminFetch(url) {
      const res = await fetch(url, {credentials: "include"});
      const ct = (res.headers.get("content-type") || "");
      const data = ct.includes("application/json") ? await res.json() : await res.text();
      if (!res.ok) throw new Error((data && data.error) || (data && data.detail) || "Request failed");
      return data;
    }

    function renderAdminMessage(m) {
      const role = m.role || "unknown";
      const content = m.content || "";
      const ts = m.created_at ? String(m.created_at) : "";
      const row = document.createElement("div");
      row.className = "tg-row " + (role === "user" ? "user" : "assistant");
      const bubble = document.createElement("div");
      bubble.className = "tg-bubble";
      const label = (role === "assistant") ? "Xiaozhi" : "User";
      bubble.innerHTML = `
        <div class="tg-name">${label}</div>
        <div class="text-sm">${content.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
        <div class="tg-meta">${ts}</div>
      `;
      if (role === "assistant") {
        const avatar = document.createElement("div");
        avatar.className = "tg-avatar";
        avatar.textContent = "X";
        row.appendChild(avatar);
      }
      row.appendChild(bubble);
      return row;
    }

    async function loadAdminMessages(threadId) {
      if (!threadId) return;
      const msgs = await adminFetch(`/api/admin/messages?thread_id=${encodeURIComponent(threadId)}&limit=200`);
      chatMessages.innerHTML = "";
      const filtered = (msgs || []).filter(m => m.role === "user" || m.role === "assistant");
      if (!filtered.length) {
        chatMessages.innerHTML = `<div class="text-xs text-slate-400">Belum ada pesan.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      filtered.forEach(m => frag.appendChild(renderAdminMessage(m)));
      chatMessages.appendChild(frag);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function loadAdminThreads(deviceId) {
      if (!deviceId) return;
      const threads = await adminFetch(`/api/admin/threads?device_id=${encodeURIComponent(deviceId)}`);
      chatThreads.innerHTML = "";
      if (!threads || threads.length === 0) {
        chatThreads.innerHTML = `<div class="text-xs text-white/60">Belum ada thread.</div>`;
        return;
      }
      threads.forEach(t => {
        const btn = document.createElement("button");
        btn.className = "w-full text-left p-3 rounded-xl border border-white/10 bg-black/20 hover:bg-black/30 text-white";
        btn.onclick = () => {
          ACTIVE_THREAD_ID = t.id;
          chatActiveThread.textContent = String(t.id);
          loadAdminMessages(t.id);
        };
        btn.innerHTML = `
          <div class="text-sm font-semibold truncate">${t.title || "New Chat"}</div>
          <div class="text-xs text-white/60 mt-1">#${t.id} - ${t.updated_at || ""}</div>
          <div class="text-[11px] text-white/60 mt-1">mode: ${t.mode_title || t.mode_name || "-"}</div>
        `;
        chatThreads.appendChild(btn);
      });
    }

    async function loadUserDevices(userId) {
      if (!userId) return;
      const data = await adminFetch(`/api/admin/user-devices?user_id=${encodeURIComponent(userId)}`);
      const devices = data.devices || [];
      chatDeviceSelect.innerHTML = "";
      if (!devices.length) {
        chatDeviceSelect.innerHTML = `<option value="">-- belum ada device --</option>`;
        return;
      }
      devices.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        chatDeviceSelect.appendChild(opt);
      });
      chatDeviceSelect.value = devices[0] || "";
      loadAdminThreads(chatDeviceSelect.value);
    }

    chatUserSelect?.addEventListener("change", () => {
      const uid = chatUserSelect.value;
      chatThreads.innerHTML = "";
      chatMessages.innerHTML = "";
      chatActiveThread.textContent = "-";
      loadUserDevices(uid).catch(() => {});
    });
    chatDeviceSelect?.addEventListener("change", () => {
      chatThreads.innerHTML = "";
      chatMessages.innerHTML = "";
      chatActiveThread.textContent = "-";
      loadAdminThreads(chatDeviceSelect.value).catch(() => {});
    });
    chatReloadBtn?.addEventListener("click", () => {
      if (chatDeviceSelect.value) loadAdminThreads(chatDeviceSelect.value);
    });

    // --- Monitoring ---
    function markUpdated(ids) {
      const now = new Date().toLocaleTimeString("id-ID");
      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.textContent = now;
      });
    }

    function setCardAlert(cardId, on) {
      const card = document.getElementById(cardId);
      if (!card) return;
      card.classList.toggle("border-red-400/60", !!on);
      card.classList.toggle("bg-red-500/10", !!on);
    }

    function beepAlert() {
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        const ctx = new Ctx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.04;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(() => {
          try {
            osc.stop();
            ctx.close();
          } catch (e) {}
        }, 140);
      } catch (e) {}
    }

    let LAST_ALERT_KEY = "";

    function renderAlerts(alerts) {
      const box = document.getElementById("mAlerts");
      if (!box) return;
      if (!alerts.length) {
        box.classList.add("hidden");
        box.classList.remove("bg-red-500/20", "border-red-400/30", "text-red-100");
        box.innerHTML = "";
        LAST_ALERT_KEY = "";
        return;
      }
      box.classList.remove("hidden");
      box.classList.add("bg-red-500/20", "border-red-400/30", "text-red-100");
      box.innerHTML = alerts.map((a) => `- ${a}`).join("<br>");
      const key = alerts.join("||");
      if (key !== LAST_ALERT_KEY) {
        beepAlert();
        showToast("Monitoring alert terdeteksi. Cek panel Monitoring.", false);
      }
      LAST_ALERT_KEY = key;
    }

    async function loadMetrics(scope = "all") {
      try {
        const data = await adminFetch("/api/admin/metrics");
        const up = data.uptime_sec || 0;
        const upH = Math.floor(up / 3600);
        const upM = Math.floor((up % 3600) / 60);
        const upS = Math.floor(up % 60);
        document.getElementById("mUptime").textContent = `${upH}h ${upM}m ${upS}s`;

        document.getElementById("mHttpRate").textContent = `${data.http_last_1m || 0} / ${data.http_last_5m || 0}`;
        document.getElementById("mHttpTotal").textContent = data.http_total ?? "-";
        document.getElementById("mHttpErr").textContent = data.http_errors ?? "-";
        document.getElementById("mHttpErrRate").textContent = `${(data.http_error_rate_1m_pct ?? 0).toFixed(2)}%`;

        document.getElementById("mMsgRate").textContent = `${data.msg_last_1m || 0} / ${data.msg_last_5m || 0}`;
        document.getElementById("mMsgTotal").textContent = data.msg_total ?? "-";

        document.getElementById("mWsClients").textContent = data.ws_clients ?? "-";
        document.getElementById("mMcpWorkers").textContent = data.mcp_workers ?? "-";
        document.getElementById("mMcpEnabled").textContent = data.mcp_supervisor_enabled ? "yes" : "no";
        document.getElementById("mThreads").textContent = data.threads ?? "-";

        if (data.process_mem_mb != null) {
          document.getElementById("mMem").textContent = `${data.process_mem_mb.toFixed(1)} MB`;
        } else {
          document.getElementById("mMem").textContent = "n/a";
        }

        const cTot = data.codes_total;
        const cCon = data.codes_connected;
        document.getElementById("mCodes").textContent =
          (cCon == null || cTot == null) ? "-" : `${cCon} / ${cTot}`;
        document.getElementById("mCodeErrors").textContent = data.codes_error ?? "-";

        const dbStatus = data.db_status || {};
        document.getElementById("mDbStatus").textContent = dbStatus.ok ? "OK" : "DOWN";
        document.getElementById("mDbLatency").textContent =
          (dbStatus.latency_ms == null) ? "-" : `${dbStatus.latency_ms} ms`;
        document.getElementById("mDbError").textContent = dbStatus.error || "-";

        const mcpStatus = data.mcp_status || {};
        document.getElementById("mMcpHealth").textContent = (mcpStatus.overall || "unknown").toUpperCase();
        const disc = (mcpStatus.disconnected == null) ? "-" : mcpStatus.disconnected;
        document.getElementById("mMcpDetail").textContent =
          `connected=${mcpStatus.connected ?? "-"} / total=${mcpStatus.total ?? "-"} | disconnected=${disc} | errors=${mcpStatus.errors ?? "-"}`;

        const stampMap = {
          uptime: ["mUptimeAt"],
          http: ["mHttpAt"],
          messages: ["mMsgAt"],
          ws: ["mWsAt"],
          workers: ["mWorkersAt"],
          memory: ["mMemAt"],
          codes: ["mCodesAt"],
          db: ["mDbAt"],
          mcp: ["mMcpAt"],
          all: ["mUptimeAt", "mHttpAt", "mMsgAt", "mWsAt", "mWorkersAt", "mMemAt", "mCodesAt", "mDbAt", "mMcpAt"],
        };
        markUpdated(stampMap[scope] || stampMap.all);

        const thresholds = data.thresholds || {};
        const memLimit = Number(thresholds.mem_mb || 600);
        const httpErrRateLimit = Number(thresholds.http_error_rate_pct || 20);
        const mcpWorkersMin = Number(thresholds.mcp_workers_min || 1);
        const mcpDisconnectedLimit = Number(thresholds.mcp_disconnected_pct || 50);

        const memNow = Number(data.process_mem_mb || 0);
        const errRateNow = Number(data.http_error_rate_1m_pct || 0);
        const workersNow = Number(data.mcp_workers || 0);
        const mcpTotalNow = Number(mcpStatus.total || 0);
        const mcpDiscNow = Number(mcpStatus.disconnected || 0);
        const mcpErrNow = Number(mcpStatus.errors || 0);
        const mcpDiscPct = (mcpTotalNow > 0) ? ((mcpDiscNow / mcpTotalNow) * 100.0) : 0.0;
        const alerts = [];

        const memAlert = memNow > memLimit;
        const errRateAlert = (Number(data.http_last_1m || 0) >= 5) && errRateNow > httpErrRateLimit;
        const workerAlert = Boolean(data.mcp_supervisor_enabled) && workersNow < mcpWorkersMin;
        const dbAlert = !dbStatus.ok;
        const mcpDownAlert = (mcpStatus.overall === "down");
        const mcpDisconnectedAlert = (mcpTotalNow > 0) && (mcpDiscPct >= mcpDisconnectedLimit);
        const mcpErrorAlert = mcpErrNow > 0;
        const mcpHealthAlert = mcpDownAlert || mcpDisconnectedAlert || mcpErrorAlert;

        if (memAlert) alerts.push(`Memory tinggi: ${memNow.toFixed(1)} MB (limit ${memLimit} MB)`);
        if (errRateAlert) alerts.push(`HTTP error rate 1m tinggi: ${errRateNow.toFixed(2)}% (limit ${httpErrRateLimit}%)`);
        if (workerAlert) alerts.push(`MCP workers rendah: ${workersNow} (minimum ${mcpWorkersMin})`);
        if (dbAlert) alerts.push(`DB bermasalah: ${dbStatus.error || "query gagal"}`);
        if (mcpDownAlert) alerts.push("MCP health DOWN: semua code terputus");
        if (mcpDisconnectedAlert) alerts.push(`MCP disconnected tinggi: ${mcpDiscPct.toFixed(1)}% (limit ${mcpDisconnectedLimit}%)`);
        if (mcpErrorAlert) alerts.push(`MCP memiliki ${mcpErrNow} code dengan last_error`);

        setCardAlert("cardMem", memAlert);
        setCardAlert("cardHttp", errRateAlert);
        setCardAlert("cardWorkers", workerAlert);
        setCardAlert("cardDb", dbAlert);
        setCardAlert("cardMcpHealth", mcpHealthAlert);
        renderAlerts(alerts);
      } catch (e) {
        showToast(`Monitoring fetch error: ${e.message || e}`, false);
      }
    }

    document.querySelectorAll("[data-m-refresh]").forEach((btn) => {
      btn.addEventListener("click", () => {
        loadMetrics(btn.getAttribute("data-m-refresh") || "all");
      });
    });

    if (ACTIVE_PAGE === "monitoring") {
      loadMetrics("all");
      setInterval(() => loadMetrics("all"), 5000);
    }
  </script>
</body>
</html>
