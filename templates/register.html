<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - SciG Mode MCP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {% include "_neo_theme_head.html" %}
  <style>
    @keyframes pulseRing {
      0% { transform: scale(0.9); opacity: 0.35; }
      70% { transform: scale(1.25); opacity: 0; }
      100% { transform: scale(1.25); opacity: 0; }
    }
    @keyframes spinFast {
      to { transform: rotate(360deg); }
    }
    .auth-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1.05fr 1fr;
    }
    .neo-showcase {
      border: 3px solid #111;
      box-shadow: 6px 6px 0 #111;
      border-radius: 22px;
      padding: 1.25rem;
      background: #fff8d7;
      min-height: 520px;
      position: relative;
      overflow: hidden;
    }
    .neo-showcase .shape-a {
      width: 210px;
      height: 210px;
      border: 3px solid #111;
      background: #73d0ff;
      position: absolute;
      top: -74px;
      right: -65px;
      transform: rotate(18deg);
      box-shadow: 6px 6px 0 #111;
    }
    .neo-showcase .shape-b {
      width: 170px;
      height: 170px;
      border: 3px solid #111;
      background: #ff9f9f;
      border-radius: 999px;
      position: absolute;
      bottom: -72px;
      left: -58px;
      box-shadow: 6px 6px 0 #111;
    }
    .showcase-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
      margin-top: 1rem;
      position: relative;
      z-index: 2;
    }
    .showcase-item {
      border: 2px solid #111;
      box-shadow: 3px 3px 0 #111;
      border-radius: 14px;
      background: #fffef8;
      padding: 0.72rem;
      font-size: 0.79rem;
      font-weight: 700;
    }
    .auth-card {
      border: 3px solid #111;
      box-shadow: 8px 8px 0 #111;
      border-radius: 24px;
      background: #fffef8;
    }
    .pair-badge {
      border: 2px solid #111;
      box-shadow: 3px 3px 0 #111;
    }
    @media (max-width: 980px) {
      .auth-grid {
        grid-template-columns: 1fr;
      }
      .neo-showcase {
        min-height: 240px;
      }
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-6xl auth-grid">
    <section class="neo-showcase">
      <div class="shape-a"></div>
      <div class="shape-b"></div>
      <div class="relative z-[2]">
        <p class="text-xs font-semibold tracking-wide">PAIRING FLOW</p>
        <h1 class="text-3xl md:text-4xl font-bold mt-3 leading-tight">Register dengan Code MCP</h1>
        <p class="mt-3 text-sm max-w-md">
          Sistem akan validasi code otomatis. Jika code valid, akun langsung terhubung ke akses yang benar.
        </p>
      </div>
      <div class="showcase-grid">
        <div class="showcase-item">Code Check</div>
        <div class="showcase-item">Role Detection</div>
        <div class="showcase-item">Auto Claim</div>
        <div class="showcase-item">Secure Access</div>
      </div>
    </section>

    <section class="auth-card p-8">
      <div class="mb-6">
        <p class="text-xs font-semibold tracking-wide">SCIG MODE MCP</p>
        <h2 class="text-2xl font-bold mt-1">Register Akun</h2>
        <p class="text-sm text-white/70 mt-1">Lengkapi form dan tunggu status pairing code.</p>
      </div>

      <form method="POST" action="/register" class="space-y-4" id="regForm">
        <div>
          <label class="block text-sm text-white/80 mb-1">Username</label>
          <input type="text" name="username" required id="username"
            class="w-full bg-black/30 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400">
        </div>

        <div>
          <label class="block text-sm text-white/80 mb-1">Password</label>
          <input type="password" name="password" required id="password"
            class="w-full bg-black/30 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400">
        </div>

        <div>
          <label class="block text-sm text-white/80 mb-1">Konfirmasi Password</label>
          <input type="password" name="confirm_password" required id="confirm_password"
            class="w-full bg-black/30 border border-white/15 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400">
          <p class="text-xs mt-1 hidden" id="pwHint"></p>
        </div>

        <div>
          <label class="block text-sm text-white/80 mb-1">Kode</label>
          <div class="relative">
            <input type="text" name="code" required maxlength="10" id="code"
              class="w-full bg-black/30 border border-white/15 rounded-xl px-3 py-2 pr-28 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="10 karakter (user) atau admin master code">

            <div class="absolute top-1/2 -translate-y-1/2 right-2 flex items-center gap-2">
              <div class="relative w-6 h-6 hidden" id="pairingAnim" aria-hidden="true">
                <div class="absolute inset-0 rounded-full border border-emerald-300/70"></div>
                <div class="absolute inset-0 rounded-full border border-emerald-300/70" style="animation: pulseRing 1.1s infinite;"></div>
                <div class="absolute inset-1 rounded-full border-2 border-emerald-400/70 border-t-transparent"
                     style="animation: spinFast 0.75s linear infinite;"></div>
              </div>

              <span id="codeBadge"
                class="pair-badge text-xs px-2.5 py-1 rounded-full border border-white/15 bg-black/25 text-white/70">
                Belum dicek
              </span>
            </div>
          </div>

          <p class="text-xs mt-2 text-white/70" id="codeHint"></p>
        </div>

        <button type="submit" id="btnRegister" disabled
          class="w-full py-2.5 rounded-xl font-semibold transition
                 bg-emerald-600/40 text-white/60 cursor-not-allowed
                 disabled:opacity-100 disabled:shadow-none">
          Register (pairing dulu...)
        </button>
      </form>

      <div class="mt-6 text-sm text-white/80">
        Sudah punya akun?
        <a href="/login" class="text-blue-300 hover:text-blue-200 underline underline-offset-4">
          Login di sini
        </a>
      </div>

      {% if error %}
        <div class="mt-5 p-3 rounded-xl bg-red-500/15 border border-red-500/30 text-red-100 text-sm">
          {{ error }}
        </div>
      {% endif %}
    </section>
  </div>

  <script>
    const elCode = document.getElementById("code");
    const elBadge = document.getElementById("codeBadge");
    const elHint = document.getElementById("codeHint");
    const elPair = document.getElementById("pairingAnim");
    const btn = document.getElementById("btnRegister");

    const pw = document.getElementById("password");
    const pw2 = document.getElementById("confirm_password");
    const pwHint = document.getElementById("pwHint");
    const username = document.getElementById("username");

    let codeOk = false;
    let pwOk = false;
    let userOk = false;
    let debounce = null;

    function setBtnState() {
      userOk = (username.value || "").trim().length > 0;
      const ok = codeOk && pwOk && userOk;

      if (ok) {
        btn.disabled = false;
        btn.className = "w-full py-2.5 rounded-xl font-semibold bg-emerald-600 hover:bg-emerald-500 transition";
        btn.textContent = "Register";
      } else {
        btn.disabled = true;
        btn.className = "w-full py-2.5 rounded-xl font-semibold transition bg-emerald-600/40 text-white/60 cursor-not-allowed disabled:opacity-100 disabled:shadow-none";
        btn.textContent = "Register (pairing dulu...)";
      }
    }

    function setBadge(kind, text) {
      if (kind === "checking") {
        elBadge.className = "pair-badge text-xs px-2.5 py-1 rounded-full border border-white/15 bg-black/25 text-white/80";
      } else if (kind === "ok") {
        elBadge.className = "pair-badge text-xs px-2.5 py-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 text-emerald-200";
      } else if (kind === "used") {
        elBadge.className = "pair-badge text-xs px-2.5 py-1 rounded-full border border-amber-400/40 bg-amber-500/15 text-amber-200";
      } else if (kind === "bad") {
        elBadge.className = "pair-badge text-xs px-2.5 py-1 rounded-full border border-red-400/40 bg-red-500/15 text-red-200";
      } else {
        elBadge.className = "pair-badge text-xs px-2.5 py-1 rounded-full border border-white/15 bg-black/25 text-white/70";
      }
      elBadge.textContent = text;
    }

    function checkPw() {
      const a = pw.value || "";
      const b = pw2.value || "";
      if (!a || !b) {
        pwOk = false;
        pwHint.classList.add("hidden");
        setBtnState();
        return;
      }
      if (a !== b) {
        pwOk = false;
        pwHint.textContent = "Password dan konfirmasi tidak sama.";
        pwHint.className = "text-xs mt-1 text-red-200";
        pwHint.classList.remove("hidden");
      } else {
        pwOk = true;
        pwHint.textContent = "Password cocok (OK).";
        pwHint.className = "text-xs mt-1 text-emerald-200";
        pwHint.classList.remove("hidden");
      }
      setBtnState();
    }

    async function validateCodeNow() {
      const code = (elCode.value || "").trim();
      codeOk = false;
      elHint.textContent = "";

      if (!code) {
        elPair.classList.add("hidden");
        setBadge("idle", "Belum dicek");
        setBtnState();
        return;
      }

      elPair.classList.remove("hidden");
      setBadge("checking", "Pairing...");

      try {
        const res = await fetch(`/api/public/validate-code?code=${encodeURIComponent(code)}`);
        const data = await res.json();

        elPair.classList.add("hidden");

        if (!data.ok) {
          codeOk = false;
          setBadge("bad", "Invalid");
          elHint.textContent = data.message || "Kode tidak valid.";
          elHint.className = "text-xs mt-2 text-red-200";
          setBtnState();
          return;
        }

        if (data.kind === "admin") {
          codeOk = true;
          setBadge("ok", "Admin OK");
          elHint.textContent = "Admin master code valid. Akun akan jadi Admin.";
          elHint.className = "text-xs mt-2 text-emerald-200";
          setBtnState();
          return;
        }

        if (data.available) {
          codeOk = true;
          setBadge("ok", "Paired OK");
          elHint.textContent = "Kode valid dan tersedia. Akan di-claim saat register.";
          elHint.className = "text-xs mt-2 text-emerald-200";
        } else {
          codeOk = false;
          setBadge("used", "Sudah dipakai");
          elHint.textContent = data.message || "Kode sudah di-claim.";
          elHint.className = "text-xs mt-2 text-amber-200";
        }
        setBtnState();
      } catch (e) {
        elPair.classList.add("hidden");
        codeOk = false;
        setBadge("bad", "Error");
        elHint.textContent = "Gagal cek kode (server error).";
        elHint.className = "text-xs mt-2 text-red-200";
        setBtnState();
      }
    }

    elCode.addEventListener("input", () => {
      clearTimeout(debounce);
      debounce = setTimeout(validateCodeNow, 350);
    });

    pw.addEventListener("input", checkPw);
    pw2.addEventListener("input", checkPw);
    username.addEventListener("input", () => setBtnState());

    setBtnState();
  </script>
</body>
</html>
