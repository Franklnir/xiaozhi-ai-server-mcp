<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SciG Mode Dashboard - Realtime</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {% include "_neo_theme_head.html" %}
  <style>
    .card {
      background: #fffef7;
      border: 2px solid #111;
      border-radius: 18px;
      box-shadow: 4px 4px 0 #111;
    }
    .inp {
      background: #fffdf7;
      border: 2px solid #111;
      border-radius: 14px;
      padding: 0.6rem 0.75rem;
      width: 100%;
      box-shadow: 3px 3px 0 #111;
    }
    .btn {
      border-radius: 14px;
      padding: 0.55rem 0.9rem;
      font-weight: 700;
    }
    .muted {
      color: #333;
    }
    .chip {
      border: 2px solid #111;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 12px;
      background: #fff8d4;
      box-shadow: 3px 3px 0 #111;
    }
    .thin {
      scrollbar-width: thin;
    }
    .dash-hero {
      border: 3px solid #111;
      box-shadow: 6px 6px 0 #111;
      border-radius: 22px;
      background: #fffef8;
    }

    .chat-shell{
      background:
        radial-gradient(circle at 9px 9px, rgba(0,0,0,.1) 1px, transparent 1.2px) 0 0 / 20px 20px,
        #fffef8;
      border: 2px solid #111;
      border-radius: 18px;
    }
    .msg-row { display: flex; gap: 10px; margin: 12px 0; align-items: flex-end; }
    .msg-row.user { justify-content: flex-end; }
    .msg-row.assistant { justify-content: flex-start; }
    .msg-avatar{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fffef8;
      color: #111;
      font-weight: 700;
      font-size: 12px;
      border: 2px solid #111;
      box-shadow: 3px 3px 0 #111;
    }
    .msg-bubble{
      max-width: 74%;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: 3px 3px 0 #111;
      border: 2px solid #111;
    }
    .msg-row.user .msg-bubble{
      background: #b8e1ff;
      border-radius: 16px 16px 6px 16px;
    }
    .msg-row.assistant .msg-bubble{
      background: #ffd7ad;
      border-radius: 16px 16px 16px 6px;
    }
    .msg-name { font-weight: 700; font-size: 11px; color: #111; margin-bottom: 4px; }
    .msg-meta { margin-top: 6px; font-size: 10px; color: #222; text-align: right; }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-10 py-2">
    <div class="dash-hero max-w-[1500px] w-full mx-auto px-4 py-4 flex items-center justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-extrabold text-blue-300">
          SciG Mode Dashboard <span class="chip ml-2 text-emerald-200 bg-emerald-500/10">REALTIME</span>
        </h1>
        <div class="text-xs muted mt-1">PSID hanya: default + psid_1..psid_4. Device lain masuk "default".</div>
      </div>

      <div class="flex items-center gap-3">
        <div id="wsStatus" class="chip bg-slate-900/60 text-slate-200">WS: Connecting...</div>
        <div class="text-sm text-slate-200">{{ username }}</div>
        <a href="/logout" class="btn bg-red-600 hover:bg-red-500 text-white text-sm">Logout</a>
      </div>
    </div>
  </header>

  <main class="max-w-[1500px] w-full mx-auto p-4 md:p-8 space-y-6">

    <!-- Quick info -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card p-4">
        <div class="text-sm font-bold">Routing</div>
        <div class="text-xs muted mt-1">Terakhir physical device & PSID aktif.</div>
        <div class="mt-3 space-y-2 text-sm">
          <div class="flex items-center justify-between">
            <span class="muted">Last Physical</span>
            <span class="font-mono text-xs" id="lastPhysical">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="muted">Active PSID</span>
            <span class="font-mono text-xs" id="activePsid">-</span>
          </div>
        </div>
        <button class="mt-4 btn bg-slate-800 hover:bg-slate-700 text-white w-full text-sm" onclick="refreshAll()">
          Refresh
        </button>

        <div class="mt-4 border-t border-white/10 pt-4">
          <div class="text-xs muted mb-2">Tips</div>
          <div class="text-xs text-slate-300">
            Kalau Xiaozhi sudah connect tapi PSID salah, set PSID lalu apply mode. Server akan auto-route last physical ke PSID.
          </div>
        </div>
      </div>

      <div class="card p-4 md:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-bold">My MCP Codes</div>
            <div class="text-xs muted mt-1">
              Daftar kode MCP yang sudah kamu miliki.
              <span class="text-amber-200">Claim tidak tersedia di dashboard</span> (claim hanya lewat halaman Register).
            </div>
          </div>
          <div class="chip bg-blue-500/10 text-blue-200">User Area</div>
        </div>

        <div class="mt-4 border-t border-white/10 pt-4">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold">My Codes</div>
            <button class="btn bg-slate-800 hover:bg-slate-700 text-white text-sm" onclick="loadMyCodes()">Reload</button>
          </div>
          <div id="myCodes" class="mt-3 space-y-2 text-sm"></div>
          <div class="mt-3 text-xs muted">
            Butuh claim? Silakan register user baru dengan code 10 karakter (claim otomatis saat register). Admin bisa "Unclaim" dari halaman Admin bila perlu.
          </div>
        </div>
      </div>
    </section>

    <!-- Mode + Language -->
    <section class="card p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm font-bold">Mode & Language (per PSID)</div>
          <div class="text-xs muted mt-1">Pilih PSID yang mau kamu kontrol, lalu set mode dan bahasa.</div>
        </div>
        <div class="chip bg-purple-500/10 text-purple-200">Per-Device</div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs muted">PSID (otomatis dari mode)</label>
          <select id="psidSelect" class="inp text-sm" disabled></select>
          <div class="text-[11px] muted mt-1">PSID tidak bisa dipilih manual. Ikuti mode.</div>
        </div>

        <div>
          <label class="text-xs muted">Mode</label>
          <select id="modeSelect" class="inp text-sm"></select>
        </div>

        <div class="flex items-end gap-2">
          <button class="btn bg-blue-600 hover:bg-blue-500 text-white w-full" onclick="applyMode()">
            Apply Mode
          </button>
        </div>

        <div id="langPanel" class="md:col-span-3 hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
            <div>
              <label class="text-xs muted">Source</label>
              <select id="srcLang" class="inp text-sm"></select>
            </div>
            <div>
              <label class="text-xs muted">Target</label>
              <select id="tgtLang" class="inp text-sm"></select>
            </div>
            <div class="flex items-end">
              <button class="btn bg-emerald-600 hover:bg-emerald-500 text-white w-full" onclick="saveLang()">
                Save Language
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between">
          <div class="text-xs muted">Rendered System Prompt (preview)</div>
          <button class="btn bg-slate-800 hover:bg-slate-700 text-white text-sm" onclick="previewPrompt()">Preview</button>
        </div>
        <pre id="promptPreview" class="mt-2 p-3 rounded-xl bg-black/40 border border-white/10 text-xs overflow-auto max-h-56 thin"></pre>
      </div>
    </section>

    <!-- Mode Editor -->
    <section class="card p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm font-bold">Mode Editor</div>
          <div class="text-xs muted mt-1">
            Edit title & introduction, dan delete mode non-default.
          </div>
        </div>
        <div class="chip bg-amber-500/10 text-amber-200">Editor</div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs muted">Pilih Mode</label>
          <select id="modeEditSelect" class="inp text-sm" onchange="pickModeToEdit()"></select>
        </div>

        <div>
          <label class="text-xs muted">Name</label>
          <input id="modeEditName" class="inp text-sm font-mono" placeholder="mode_name" />
          <div class="text-[11px] muted mt-1">Mode default dilindungi dari delete.</div>
        </div>

        <div>
          <label class="text-xs muted">Title</label>
          <input id="modeEditTitle" class="inp text-sm" placeholder="Judul mode" />
        </div>

        <div class="md:col-span-3">
          <label class="text-xs muted">Introduction</label>
          <textarea id="modeEditIntro" rows="6" class="inp text-sm font-mono" placeholder="Isi prompt peran / aturan..."></textarea>
        </div>

        <div class="md:col-span-3 flex gap-2">
          <button class="btn bg-slate-800 hover:bg-slate-700 text-white text-sm" onclick="newModeDraft()">+ Draft Mode Baru</button>
          <button class="btn bg-emerald-600 hover:bg-emerald-500 text-white text-sm" onclick="saveModeEdit()">Save Mode</button>
          <button id="deleteModeBtn" class="btn bg-red-700 hover:bg-red-600 text-white text-sm" onclick="deleteModeEdit()">Delete Mode</button>
        </div>

        <div class="md:col-span-3 text-sm" id="modeEditStatus"></div>
      </div>
    </section>

    <!-- Chat -->
    <section class="grid grid-cols-1 xl:grid-cols-3 gap-4">
      <!-- Threads -->
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-bold">Threads</div>
            <div class="text-xs muted mt-1">List chat untuk PSID terpilih.</div>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-2">
          <button class="btn bg-slate-800 hover:bg-slate-700 text-white text-sm w-full" onclick="loadThreads()">
            Reload Threads
          </button>
        </div>

        <div id="threads" class="mt-3 space-y-2 max-h-[520px] overflow-auto pr-1 thin"></div>
      </div>

      <!-- Messages -->
      <div class="card p-4 xl:col-span-2">
        <div class="flex items-start justify-between gap-3 flex-wrap">
          <div>
            <div class="text-sm font-bold">Messages</div>
            <div class="text-xs muted mt-1 flex flex-wrap items-center gap-2">
              <span>Thread: <span class="font-mono text-xs" id="activeThread">-</span></span>
              <span class="chip bg-slate-900/60" id="chatPsidBadge">PSID: -</span>
              <span class="chip bg-slate-900/60" id="modeBadge">Mode: -</span>
              <span class="chip bg-slate-900/60" id="threadModeBadge">Thread Mode: -</span>
            </div>
          </div>
          <div class="text-xs muted">Realtime view (30 hari terakhir)</div>
        </div>

        <div id="messages" class="mt-4 max-h-[640px] overflow-auto pr-1 thin chat-shell p-3"></div>

        <div class="mt-4 border-t border-white/10 pt-4 space-y-3">
          <div class="flex flex-col gap-2">
            <label class="text-xs muted">Pesan</label>
            <textarea id="chatInput" rows="2" class="inp text-sm" placeholder="Ketik pesan di sini..."></textarea>
          </div>

          <div class="flex items-center gap-3 flex-wrap">
            <button id="sendBtn" class="btn bg-blue-600 hover:bg-blue-500 text-white text-sm" onclick="sendMessage()">
              Kirim
            </button>
            <button id="micBtn" class="btn bg-amber-600 hover:bg-amber-500 text-white text-sm" onclick="sendVoiceOnce()">
              Mic: Kirim Suara
            </button>
            <label class="flex items-center gap-2 text-xs">
              <input type="checkbox" id="ttsToggle" class="accent-blue-500" onchange="toggleTts(this.checked)">
              Putar suara masuk (TTS)
            </label>
            <div id="sendHint" class="text-xs muted">Send dikunci: hanya boleh saat mode NORMAL.</div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- small toast -->
  <div id="toastBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 space-y-2 z-50"></div>

<script>
  // ------------------------
  // State
  // ------------------------
  let WS = null;
  let wsTimer = null;
  let REC = null;
  let REC_LISTENING = false;
  let TTS_ON = false;

  let CONFIG = null;
  let MODES = [];
  let MODE_PSID_MAP = {};
  let CURRENT_PSID = "default";
  let ACTIVE_MODE = null;
  let AUTO_SYNC_PSID = true;
  let AUTO_FOLLOW_THREAD = true;

  let THREADS = [];
  let ACTIVE_THREAD_ID = null;
  let ACTIVE_THREAD_MODE = null;
  let LAST_MESSAGE_ID = 0;
  let LAST_SPOKEN_ASSISTANT_ID = 0;
  let MSG_LIVE_TIMER = null;
  let MSG_LIVE_FETCHING = false;
  const MSG_LIVE_POLL_MS = 1200;

  let SUPPRESS_MODE_CHANGE = false;

  // ------------------------
  // Helpers
  // ------------------------
  const $ = (id) => document.getElementById(id);

  function isNearBottom(el, threshold = 140) {
    if (!el) return true;
    const delta = el.scrollHeight - el.scrollTop - el.clientHeight;
    return delta <= threshold;
  }

  async function api(url, opts = {}) {
    const o = Object.assign({
      credentials: "include",
      headers: {"Content-Type": "application/json"},
    }, opts);

    const res = await fetch(url, o);
    const ct = (res.headers.get("content-type") || "");
    const data = ct.includes("application/json") ? await res.json() : await res.text();

    if (!res.ok) {
      const msg =
        (data && data.error) ? data.error :
        (data && data.detail) ? data.detail :
        (typeof data === "string" ? data : "Request failed");
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(text, ok=null) {
    const el = $("wsStatus");
    el.textContent = text;
    el.className = "chip " + (ok === true ? "bg-emerald-500/10 text-emerald-200" : ok === false ? "bg-red-500/10 text-red-200" : "bg-slate-900/60 text-slate-200");
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s ?? "";
    return div.innerHTML;
  }

  function needsLang(modeName) {
    return modeName === "f2f_auto" || modeName === "translation_text";
  }

  const PROTECTED_MODE_NAMES = new Set([
    "f2f_auto",
    "translation_text",
    "normal",
    "santai",
    "anak_anak",
    "coding_expert",
    "sains",
    "sejarah",
    "matematika_dasar",
    "curhat",
    "psikolog"
  ]);

  function toast(msg, ok=true) {
    const box = $("toastBox");
    const el = document.createElement("div");
    el.className = "px-3 py-2 rounded-xl border text-sm shadow-lg backdrop-blur " +
      (ok ? "bg-emerald-500/10 border-emerald-400/20 text-emerald-100" : "bg-red-500/10 border-red-400/20 text-red-100");
    el.innerHTML = msg;
    box.appendChild(el);
    setTimeout(() => { try { el.remove(); } catch(e){} }, 2400);
  }

  // token display intentionally hidden in dashboard

  // ------------------------
  // WebSocket
  // ------------------------
  function connectWS() {
    try { if (WS) WS.close(); } catch(e){}
    const proto = location.protocol === "https:" ? "wss" : "ws";
    WS = new WebSocket(`${proto}://${location.host}/ws`);

    WS.onopen = () => {
      setStatus("WS: Connected", true);
      if (wsTimer) clearInterval(wsTimer);
      wsTimer = setInterval(() => {
        try { WS.send("ping"); } catch(e){}
      }, 8000);
    };

    WS.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        handleRealtime(msg);
      } catch(e) {}
    };

    WS.onclose = () => {
      setStatus("WS: Disconnected", false);
      if (wsTimer) clearInterval(wsTimer);
      setTimeout(connectWS, 1200);
    };

    WS.onerror = () => {
      setStatus("WS: Error", false);
    };
  }

  function handleRealtime(msg) {
    if (!msg || !msg.type) return;

    if (msg.type === "chat_message_sent") {
      if (msg.device_id === CURRENT_PSID) {
        if (AUTO_FOLLOW_THREAD && msg.thread_id && msg.thread_id !== ACTIVE_THREAD_ID) {
          selectThread(msg.thread_id).catch(() => {});
          return;
        }
        if (msg.thread_id === ACTIVE_THREAD_ID) {
          loadMessages({ incremental: true, keepBottom: true }).catch(() => {});
        }
        loadThreads().catch(() => {});
      }
    }

    if (msg.type === "chat_created" || msg.type === "chat_deleted") {
      if (msg.device_id === CURRENT_PSID) loadThreads();
    }

    if (msg.type === "active_mode_changed") {
      if (msg.device_id === CURRENT_PSID) loadActiveMode();
      if (AUTO_SYNC_PSID) syncPsidFromActive(msg.device_id).catch(() => {});
    }

    if (msg.type === "device_settings_changed") {
      if (msg.device_id === CURRENT_PSID) loadDeviceSettings();
    }

    if (msg.type === "route_changed") {
      loadLastDevice();
    }

    if (msg.type === "modes_updated") {
      loadModes().then(() => {
        loadActiveMode();
        previewPrompt();
      });
    }
  }

  // ------------------------
  // Speech (STT + TTS)
  // ------------------------
  function getRecognizer() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    return SR ? new SR() : null;
  }

  function sendVoiceOnce() {
    const modeName = (ACTIVE_MODE?.name || "");
    const allowed = ["normal", "f2f_auto", "translation_text"].includes(modeName);
    if (!allowed) {
      toast("Mode ini tidak mengizinkan kirim pesan.", false);
      return;
    }
    const rec = getRecognizer();
    if (!rec) {
      toast("Browser tidak mendukung SpeechRecognition. Gunakan Chrome berbasis Chromium.", false);
      return;
    }
    if (REC_LISTENING && REC) {
      try { REC.stop(); } catch(e){}
    }
    REC = rec;
    REC.lang = "id-ID";
    REC.continuous = false;
    REC.interimResults = false;
    REC.onstart = () => {
      REC_LISTENING = true;
      toast("Mendengarkan... ucapkan pesan", true);
    };
    REC.onerror = (e) => {
      REC_LISTENING = false;
      toast("Mic error: " + (e.error || "unknown"), false);
    };
    REC.onend = () => {
      REC_LISTENING = false;
    };
    REC.onresult = async (ev) => {
      const txt = (ev.results?.[0]?.[0]?.transcript || "").trim();
      if (txt) {
        await sendMessage(txt);
      } else {
        toast("Tidak ada suara terdeteksi.", false);
      }
    };
    REC.start();
  }

  function toggleTts(on) {
    TTS_ON = !!on;
    if (!('speechSynthesis' in window)) {
      toast("Browser tidak mendukung Speech Synthesis.", false);
      TTS_ON = false;
      $("ttsToggle").checked = false;
    }
  }

  function speak(text) {
    if (!TTS_ON) return;
    if (!text) return;
    if (!("speechSynthesis" in window)) return;
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "id-ID";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    } catch(e) {}
  }

  function stopMessagesRealtime() {
    if (MSG_LIVE_TIMER) {
      clearInterval(MSG_LIVE_TIMER);
      MSG_LIVE_TIMER = null;
    }
  }

  function startMessagesRealtime() {
    stopMessagesRealtime();
    MSG_LIVE_TIMER = setInterval(() => {
      if (!ACTIVE_THREAD_ID) return;
      if (document.hidden) return;
      if (MSG_LIVE_FETCHING) return;
      loadMessages({ incremental: true, keepBottom: true }).catch(() => {});
    }, MSG_LIVE_POLL_MS);
  }

  // ------------------------
  // Boot
  // ------------------------
  async function boot() {
    stopMessagesRealtime();
    connectWS();
    await loadConfig();
    fillPsids();
    fillLanguages();
    $("chatPsidBadge").textContent = `PSID: ${CURRENT_PSID}`;
    await loadLastDevice();
    await loadModes();
    await loadActiveMode();
    await loadDeviceSettings();
    await loadMyCodes();
    await loadThreads();
    await previewPrompt();
    startMessagesRealtime();
  }

  async function refreshAll() {
    await loadLastDevice();
    await loadModes();
    await loadActiveMode();
    await loadDeviceSettings();
    await loadMyCodes();
    await loadThreads();
    await previewPrompt();
    startMessagesRealtime();
  }

  async function loadConfig() {
    CONFIG = await api("/api/config");

    // fallback safety
    CONFIG.psids = CONFIG.psids || ["default","psid_1","psid_2","psid_3","psid_4"];
    CONFIG.languages = CONFIG.languages || ["Indonesia","Arab","Inggris"];
    MODE_PSID_MAP = CONFIG.mode_psid_map || {};

    const saved = localStorage.getItem("scig_psid");
    if (saved && CONFIG.psids.includes(saved)) CURRENT_PSID = saved;
  }

  function fillPsids() {
    const sel = $("psidSelect");
    sel.innerHTML = "";
    (CONFIG.psids || ["default","psid_1","psid_2","psid_3","psid_4"]).forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
    sel.value = CURRENT_PSID;
  }

  async function syncPsidFromActive(activePsid) {
    if (!AUTO_SYNC_PSID) return;
    if (!activePsid) return;
    if (!CONFIG?.psids || !CONFIG.psids.includes(activePsid)) return;
    if (activePsid === CURRENT_PSID) return;

    CURRENT_PSID = activePsid;
    localStorage.setItem("scig_psid", CURRENT_PSID);
    if ($("psidSelect")) $("psidSelect").value = CURRENT_PSID;
    await onPsidChanged();
  }

  function fillLanguages() {
    const langs = CONFIG.languages || [];
    const src = $("srcLang"), tgt = $("tgtLang");
    src.innerHTML = ""; tgt.innerHTML = "";
    langs.forEach(l => {
      const o1 = document.createElement("option");
      o1.value = l; o1.textContent = l;
      src.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = l; o2.textContent = l;
      tgt.appendChild(o2);
    });
  }

  async function loadLastDevice() {
    const d = await api("/api/last-device");
    $("lastPhysical").textContent = d.last_physical_device_id || "-";
    $("activePsid").textContent = d.active_psid || "-";
    await syncPsidFromActive(d.active_psid);
  }

  async function loadModes() {
    MODES = await api("/api/modes");

    const sel = $("modeSelect");
    sel.innerHTML = "";
    MODES.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = `${m.title}  [${m.name}]`;
      sel.appendChild(opt);
    });

    const ed = $("modeEditSelect");
    if (ed) {
      const current = ed.value;
      ed.innerHTML = "";
      MODES.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = `${m.name}`;
        ed.appendChild(opt);
      });

      if (MODES.length) {
        const stillExists = MODES.some(m => String(m.id) === String(current));
        ed.value = stillExists ? String(current) : String(MODES[0].id);
        pickModeToEdit();
      }
    }
  }

  async function loadActiveMode() {
    ACTIVE_MODE = await api(`/api/mode?device_id=${encodeURIComponent(CURRENT_PSID)}`);
    $("modeBadge").textContent = `Mode: ${ACTIVE_MODE?.title || ACTIVE_MODE?.name || "-"}`;

    if (ACTIVE_MODE && $("modeSelect")) {
      SUPPRESS_MODE_CHANGE = true;
      $("modeSelect").value = String(ACTIVE_MODE.id || "");
      SUPPRESS_MODE_CHANGE = false;
    }

    $("langPanel").classList.toggle("hidden", !needsLang(ACTIVE_MODE?.name || ""));
    updateSendState();
  }

  async function loadDeviceSettings() {
    const st = await api(`/api/device/settings?device_id=${encodeURIComponent(CURRENT_PSID)}`);
    if ($("srcLang")) $("srcLang").value = st.source || "Indonesia";
    if ($("tgtLang")) $("tgtLang").value = st.target || "Arab";
  }

  function updateSendState() {
    const modeName = (ACTIVE_MODE?.name || "");
    const allowed = ["normal", "f2f_auto", "translation_text"].includes(modeName);
    const btn = $("sendBtn");
    const micBtn = $("micBtn");
    const hint = $("sendHint");
    if (btn) {
      btn.disabled = !allowed;
      btn.classList.toggle("opacity-50", !allowed);
      btn.classList.toggle("cursor-not-allowed", !allowed);
    }
    if (micBtn) {
      micBtn.disabled = !allowed;
      micBtn.classList.toggle("opacity-50", !allowed);
      micBtn.classList.toggle("cursor-not-allowed", !allowed);
    }
    if (hint) {
      if (!allowed) {
        hint.textContent = "Send dikunci: hanya boleh saat mode Normal / F2F / Terjemahan.";
      } else {
        hint.textContent = "Siap kirim pesan.";
      }
    }
  }

  async function onPsidChanged() {
    CURRENT_PSID = $("psidSelect").value;
    localStorage.setItem("scig_psid", CURRENT_PSID);

    stopMessagesRealtime();
    ACTIVE_THREAD_ID = null;
    ACTIVE_THREAD_MODE = null;
    LAST_MESSAGE_ID = 0;
    LAST_SPOKEN_ASSISTANT_ID = 0;
    $("activeThread").textContent = "-";
    $("threadModeBadge").textContent = "Thread Mode: -";
    $("chatPsidBadge").textContent = `PSID: ${CURRENT_PSID}`;
    $("messages").innerHTML = "";

    await loadActiveMode();
    await loadDeviceSettings();
    await loadThreads();
    await previewPrompt();
    startMessagesRealtime();
  }

  async function applyMode() {
    const modeId = parseInt($("modeSelect").value, 10);
    try {
      const res = await api("/api/mode", {method:"POST", body: JSON.stringify({device_id: CURRENT_PSID, mode_id: modeId})});
      await loadActiveMode();
      await previewPrompt();
      await loadLastDevice();
      toast(`OK Mode updated: <b>${escapeHtml(res.title || res.name || "OK")}</b>`, true);
    } catch(e) {
      toast(`ERR ${escapeHtml(e.message)}`, false);
    }
  }

  async function saveLang() {
    try {
      const source = $("srcLang").value;
      const target = $("tgtLang").value;
      await api("/api/device/settings", {method:"POST", body: JSON.stringify({device_id: CURRENT_PSID, source, target})});
      await previewPrompt();
      toast("OK Language saved", true);
    } catch(e) {
      toast(`ERR ${escapeHtml(e.message)}`, false);
    }
  }

  async function previewPrompt() {
    try {
      const vars = {
        source: $("srcLang")?.value || "Indonesia",
        target: $("tgtLang")?.value || "Arab"
      };
      const out = await api("/api/render-prompt", {method:"POST", body: JSON.stringify({mode_id: ACTIVE_MODE?.id || null, vars})});
      $("promptPreview").textContent = out.prompt || "";
    } catch(e) {
      $("promptPreview").textContent = `Error: ${e.message}`;
    }
  }

  // ------------------------
  // My MCP Codes (read-only)
  // ------------------------
  async function loadMyCodes() {
    const list = await api("/api/mcp/my-codes");
    const wrap = $("myCodes");
    wrap.innerHTML = "";

    if (!list || list.length === 0) {
      wrap.innerHTML = `<div class="text-xs muted">Belum ada code yang kamu miliki.</div>`;
      return;
    }

    list.forEach((c) => {
      const ok = !!c.is_connected;
      const box = document.createElement("div");
      box.className = "p-3 rounded-xl border border-white/10 bg-black/20";

      box.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="font-mono text-sm">${escapeHtml(c.code)}</div>
          <div class="text-xs ${ok ? "text-emerald-200" : "text-red-200"}">
            ${ok ? "Connected" : "Disconnected"}
          </div>
        </div>

        ${c.last_error ? `<div class="mt-2 text-[11px] text-red-300 truncate" title="${escapeHtml(c.last_error)}">${escapeHtml(c.last_error)}</div>` : ``}
      `;

      wrap.appendChild(box);
    });
  }

  // ------------------------
  // Mode Editor
  // ------------------------
  function pickModeToEdit() {
    const ed = $("modeEditSelect");
    if (!ed || !MODES.length) return;

    const id = parseInt(ed.value, 10);
    const m = MODES.find(x => x.id === id);
    if (!m) return;

    $("modeEditName").value = m.name || "";
    $("modeEditTitle").value = m.title || "";
    $("modeEditIntro").value = m.introduction || "";

    const isProtected = PROTECTED_MODE_NAMES.has(m.name || "");
    const delBtn = $("deleteModeBtn");
    if (delBtn) {
      delBtn.disabled = isProtected;
      delBtn.classList.toggle("opacity-50", isProtected);
      delBtn.classList.toggle("cursor-not-allowed", isProtected);
      delBtn.title = isProtected ? "Mode default tidak bisa dihapus" : "Hapus mode ini";
    }

    const note = isProtected
      ? "Mode default (dilindungi, tidak bisa dihapus)."
      : "Mode custom/non-default bisa dihapus.";
    $("modeEditStatus").innerHTML = `<span class="text-xs muted">Editing: <span class="font-mono">${escapeHtml(m.name)}</span> - ${escapeHtml(note)}</span>`;
  }

  function newModeDraft() {
    $("modeEditName").value = "custom_mode";
    $("modeEditTitle").value = "Custom Mode";
    $("modeEditIntro").value = "PERAN: ...\nGAYA: ...\nATURAN:\n- ...";
    $("modeEditStatus").innerHTML = `<span class="text-xs muted">Draft mode baru siap. Tinggal Save.</span>`;
    const delBtn = $("deleteModeBtn");
    if (delBtn) {
      delBtn.disabled = true;
      delBtn.classList.add("opacity-50", "cursor-not-allowed");
      delBtn.title = "Simpan dulu mode baru sebelum bisa dihapus";
    }
  }

  async function saveModeEdit() {
    const name = ($("modeEditName").value || "").trim();
    const title = ($("modeEditTitle").value || "").trim();
    const introduction = ($("modeEditIntro").value || "").trim();

    if (!name || !title || !introduction) {
      $("modeEditStatus").innerHTML = `<span class="text-red-200 text-sm">ERR name/title/introduction wajib diisi</span>`;
      return;
    }

    try {
      await api("/api/modes", {method:"POST", body: JSON.stringify({name, title, introduction})});
      $("modeEditStatus").innerHTML = `<span class="text-emerald-200 text-sm">OK Saved</span>`;
      toast("OK Mode tersimpan", true);
      await loadModes();
      await loadActiveMode();
      await previewPrompt();
    } catch(e) {
      $("modeEditStatus").innerHTML = `<span class="text-red-200 text-sm">ERR ${escapeHtml(e.message)}</span>`;
      toast("ERR " + escapeHtml(e.message), false);
    }
  }

  async function deleteModeEdit() {
    const id = parseInt(($("modeEditSelect")?.value || "0"), 10);
    const m = MODES.find(x => x.id === id);
    if (!m) {
      toast("Mode tidak ditemukan.", false);
      return;
    }
    if (PROTECTED_MODE_NAMES.has(m.name || "")) {
      toast("Mode default tidak boleh dihapus.", false);
      return;
    }

    const ok = window.confirm(`Hapus mode '${m.name}'?`);
    if (!ok) return;

    try {
      await api(`/api/modes/${encodeURIComponent(String(id))}`, {method:"DELETE"});
      $("modeEditStatus").innerHTML = `<span class="text-emerald-200 text-sm">OK Mode dihapus</span>`;
      toast("OK Mode dihapus", true);
      await loadModes();
      await loadActiveMode();
      await previewPrompt();
    } catch(e) {
      $("modeEditStatus").innerHTML = `<span class="text-red-200 text-sm">ERR ${escapeHtml(e.message)}</span>`;
      toast("ERR " + escapeHtml(e.message), false);
    }
  }

  // ------------------------
  // Threads & Messages
  // ------------------------
  async function loadThreads() {
    const threads = await api(`/api/chats?device_id=${encodeURIComponent(CURRENT_PSID)}`);
    THREADS = threads || [];
    const wrap = $("threads");
    wrap.innerHTML = "";

    if (THREADS.length === 0) {
      ACTIVE_THREAD_ID = null;
      ACTIVE_THREAD_MODE = null;
      LAST_MESSAGE_ID = 0;
      LAST_SPOKEN_ASSISTANT_ID = 0;
      wrap.innerHTML = `<div class="text-xs muted">Belum ada thread.</div>`;
      if ($("messages")) $("messages").innerHTML = `<div class="text-xs muted">Belum ada pesan.</div>`;
      if ($("activeThread")) $("activeThread").textContent = "-";
      if ($("threadModeBadge")) $("threadModeBadge").textContent = "Thread Mode: -";
      return;
    }

    THREADS.forEach(t => {
      const active = (t.id === ACTIVE_THREAD_ID);
      const btn = document.createElement("button");
      btn.className =
        "w-full text-left p-3 rounded-xl border border-white/10 " +
        (active ? "bg-blue-500/15" : "bg-black/15 hover:bg-black/25");
      btn.onclick = () => selectThread(t.id);
      const modeLabel = (t.mode_title || t.mode_name || "-");
      btn.innerHTML = `
        <div class="text-sm font-semibold truncate">${escapeHtml(t.title || "New Chat")}</div>
        <div class="text-xs muted mt-1">#${escapeHtml(String(t.id))} - updated ${escapeHtml(String(t.updated_at || ""))}</div>
        <div class="text-[11px] muted mt-1">mode: ${escapeHtml(String(modeLabel))}</div>
      `;
      wrap.appendChild(btn);
    });

    if (!ACTIVE_THREAD_ID && THREADS.length > 0) {
      await selectThread(THREADS[0].id);
    }

    if (ACTIVE_THREAD_ID) {
      const t = THREADS.find(x => x.id === ACTIVE_THREAD_ID);
      if (t) {
        ACTIVE_THREAD_MODE = t.mode_title || t.mode_name || null;
        $("threadModeBadge").textContent = `Thread Mode: ${ACTIVE_THREAD_MODE || "-"}`;
      }
    }
  }

  async function newChat() {
    try {
      const r = await api("/api/chats/new", {method:"POST", body: JSON.stringify({device_id: CURRENT_PSID})});
      await loadThreads();
      await selectThread(r.id);
      toast(`OK New thread #${r.id}`, true);
    } catch(e) {
      toast(`ERR ${escapeHtml(e.message)}`, false);
    }
  }

  async function selectThread(id) {
    ACTIVE_THREAD_ID = id;
    LAST_MESSAGE_ID = 0;
    LAST_SPOKEN_ASSISTANT_ID = 0;
    $("activeThread").textContent = String(id);
    ACTIVE_THREAD_MODE = null;
    const t = THREADS.find(x => x.id === id);
    if (t) {
      ACTIVE_THREAD_MODE = t.mode_title || t.mode_name || null;
    }
    $("threadModeBadge").textContent = `Thread Mode: ${ACTIVE_THREAD_MODE || "-"}`;

    await loadThreads();
    await loadMessages({ replace: true, keepBottom: true, resetCursor: true });
    startMessagesRealtime();
  }

  function renderOneMessage(m) {
    const role = m.role || "unknown";
    const content = m.content || "";
    const ts = m.created_at ? String(m.created_at) : "";

    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "assistant");

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";

    const label = (role === "assistant") ? "Xiaozhi" : "User";

    bubble.innerHTML = `
      <div class="msg-name">${escapeHtml(label)}</div>
      <div class="text-sm text-slate-800">${escapeHtml(content)}</div>
      <div class="msg-meta">${escapeHtml(ts)}</div>
    `;

    if (role === "assistant") {
      const avatar = document.createElement("div");
      avatar.className = "msg-avatar";
      avatar.textContent = "X";
      row.appendChild(avatar);
    }

    row.appendChild(bubble);
    return row;
  }

  async function loadMessages({ replace=false, keepBottom=false, incremental=false, resetCursor=false } = {}) {
    if (!ACTIVE_THREAD_ID) return;

    const wrap = $("messages");
    const stickBottom = keepBottom || isNearBottom(wrap);
    if (resetCursor) LAST_MESSAGE_ID = 0;

    const useIncremental = Boolean(incremental && !replace && LAST_MESSAGE_ID > 0);
    if (useIncremental && MSG_LIVE_FETCHING) return;
    if (useIncremental) MSG_LIVE_FETCHING = true;

    try {
      let url = `/api/chats/${ACTIVE_THREAD_ID}/messages?device_id=${encodeURIComponent(CURRENT_PSID)}&limit=${useIncremental ? 300 : 10000}`;
      if (useIncremental) {
        url += `&after_id=${encodeURIComponent(String(LAST_MESSAGE_ID))}`;
      }

      const msgs = await api(url);
      const filtered = (msgs || []).filter(m => m.role === "user" || m.role === "assistant");

      if (!msgs || msgs.length === 0) {
        if (replace) wrap.innerHTML = `<div class="text-xs muted">Belum ada pesan.</div>`;
        return;
      }

      if (useIncremental) {
        const onlyPlaceholder =
          wrap.childElementCount === 1 &&
          String(wrap.firstElementChild?.textContent || "").toLowerCase().includes("belum ada pesan");
        if (onlyPlaceholder) wrap.innerHTML = "";

        const frag = document.createDocumentFragment();
        filtered.forEach(m => frag.appendChild(renderOneMessage(m)));
        wrap.appendChild(frag);
      } else {
        // Full render to avoid duplicated rows and keep UI consistent.
        wrap.innerHTML = "";
        const frag = document.createDocumentFragment();
        filtered.forEach(m => frag.appendChild(renderOneMessage(m)));
        wrap.appendChild(frag);
      }

      if (filtered.length === 0) {
        if (!useIncremental) {
          wrap.innerHTML = `<div class="text-xs muted">Belum ada pesan user/assistant.</div>`;
        }
        return;
      }

      const newestId = Number(filtered[filtered.length - 1]?.id || 0);
      if (newestId > LAST_MESSAGE_ID) LAST_MESSAGE_ID = newestId;

      if (stickBottom) wrap.scrollTop = wrap.scrollHeight;

      // TTS untuk pesan assistant terbaru, jangan ulang untuk id yang sama.
      if (TTS_ON) {
        for (let i = filtered.length - 1; i >= 0; i -= 1) {
          const m = filtered[i];
          if (m.role !== "assistant") continue;
          const mid = Number(m.id || 0);
          if (mid > LAST_SPOKEN_ASSISTANT_ID) {
            LAST_SPOKEN_ASSISTANT_ID = mid;
            speak(m.content || "");
          }
          break;
        }
      }
    } finally {
      if (useIncremental) MSG_LIVE_FETCHING = false;
    }
  }

  async function ensureThread() {
    if (ACTIVE_THREAD_ID) return ACTIVE_THREAD_ID;
    await newChat();
    return ACTIVE_THREAD_ID;
  }

  async function sendMessage(textOverride=null) {
    try {
      const modeName = (ACTIVE_MODE?.name || "");
      const allowed = ["normal", "f2f_auto", "translation_text"].includes(modeName);
      if (!allowed) {
        toast("Mode ini tidak mengizinkan kirim pesan.", false);
        return;
      }

      const text = ((textOverride ?? $("chatInput")?.value) || "").trim();
      if (!text) {
        toast("Isi pesan dulu.", false);
        return;
      }

      const threadId = await ensureThread();
      const body = {
        device_id: CURRENT_PSID,
        thread_id: threadId,
        message: text,
        vars: {}
      };

      await api("/api/chats/send", {method:"POST", body: JSON.stringify(body)});
      if (!textOverride && $("chatInput")) $("chatInput").value = "";
      await loadMessages({ replace: true, keepBottom: true });
      toast("Pesan terkirim.", true);
    } catch(e) {
      toast(`ERR ${escapeHtml(e.message)}`, false);
    }
  }

  window.addEventListener("load", () => {
    const modeSel = $("modeSelect");
    if (modeSel) {
      modeSel.addEventListener("change", async () => {
        if (SUPPRESS_MODE_CHANGE) return;
        const selectedModeId = parseInt(modeSel.value, 10);
        const mode = MODES.find(m => m.id === selectedModeId);
        const mappedPsid = mode && MODE_PSID_MAP[mode.name] ? MODE_PSID_MAP[mode.name] : "default";
        if (mappedPsid !== CURRENT_PSID) {
          CURRENT_PSID = mappedPsid;
          $("psidSelect").value = CURRENT_PSID;
          await onPsidChanged();
          SUPPRESS_MODE_CHANGE = true;
          $("modeSelect").value = String(selectedModeId);
          SUPPRESS_MODE_CHANGE = false;
        }
        await applyMode();
        updateSendState();
      });
    }

    boot().catch(err => {
      console.error(err);
      toast("ERR Gagal boot dashboard: " + escapeHtml(err.message), false);
    });

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && ACTIVE_THREAD_ID) {
        loadMessages({ incremental: true, keepBottom: true }).catch(() => {});
      }
    });
  });

  window.addEventListener("beforeunload", () => {
    stopMessagesRealtime();
    if (wsTimer) clearInterval(wsTimer);
    try { if (WS) WS.close(); } catch (e) {}
  });
</script>

</body>
</html>
